name: Playwright Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Test environment'
        required: true
        default: 'QA'
        type: choice
        options:
          - dev
          - QA
          - prod

jobs:
  test:
    name: Run Tests (Chromium Shard ${{ matrix.shard }}/4)
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Create test data Excel file
        run: npx ts-node POM-Tests/test-data/excel/createTestData.ts

      - name: Run Playwright tests
        env:
          TEST_ENV: ${{ github.event.inputs.environment || 'QA' }}
          ENV_PREFIX: ${{ secrets.ENV_PREFIX || 'qa2' }}
          AUTH_CREDENTIAL_KEY: ${{ secrets.AUTH_CREDENTIAL_KEY || 'RBCClient' }}
          HEADLESS: true
        run: |
          npx playwright test --project=chromium --shard=${{ matrix.shard }}/4

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-chromium-shard-${{ matrix.shard }}
          path: |
            test-runs/**/html-report/
            test-runs/**/json-report/
            test-runs/**/junit-report/
          retention-days: 30

      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-chromium-shard-${{ matrix.shard }}
          path: test-runs/**/screenshots/
          retention-days: 30

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-chromium-shard-${{ matrix.shard }}
          path: test-runs/**/allure-results/
          retention-days: 30

  report:
    name: Generate Allure Report
    needs: test
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all Allure results
        uses: actions/download-artifact@v4
        with:
          path: allure-results
          pattern: allure-results-*
          merge-multiple: true

      - name: Generate Allure report
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results
          allure_history: allure-history
          keep_reports: 20

      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      - name: Deploy Allure report to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          destination_dir: reports/${{ github.run_number }}

  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create test data Excel file
        run: npx ts-node POM-Tests/test-data/excel/createTestData.ts

      - name: Run smoke tests
        env:
          TEST_ENV: ${{ github.event.inputs.environment || 'QA' }}
          ENV_PREFIX: ${{ secrets.ENV_PREFIX || 'qa2' }}
          AUTH_CREDENTIAL_KEY: ${{ secrets.AUTH_CREDENTIAL_KEY || 'RBCClient' }}
          HEADLESS: true
        run: npm run test:smoke

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: |
            test-runs/**/html-report/
            test-runs/**/screenshots/
            test-runs/**/allure-results/
          retention-days: 7

  notify:
    name: Send Notifications
    needs: [test, smoke-test]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test results summary
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'QA' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY

      # Optional: Send Slack notification
      # - name: Send Slack notification
      #   if: failure()
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "Test execution failed!",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "‚ùå *Test Execution Failed*\n*Workflow:* ${{ github.workflow }}\n*Branch:* ${{ github.ref_name }}\n*Triggered by:* ${{ github.actor }}"
      #             }
      #           }
      #         ]
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
